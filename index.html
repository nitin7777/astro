<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Astrology App</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Google Sign-In and JWT decode libraries -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- React and Babel from CDN -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    function getZodiac(month, day) {
      const date = month * 100 + day;
      if (date >= 321 && date <= 419) return "Aries";
      if (date >= 420 && date <= 520) return "Taurus";
      if (date >= 521 && date <= 620) return "Gemini";
      if (date >= 621 && date <= 722) return "Cancer";
      if (date >= 723 && date <= 822) return "Leo";
      if (date >= 823 && date <= 922) return "Virgo";
      if (date >= 923 && date <= 1022) return "Libra";
      if (date >= 1023 && date <= 1121) return "Scorpio";
      if (date >= 1122 && date <= 1221) return "Sagittarius";
      if ((date >= 1222 && date <= 1231) || (date >= 101 && date <= 119)) return "Capricorn";
      if (date >= 120 && date <= 218) return "Aquarius";
      if (date >= 219 && date <= 320) return "Pisces";
      return "Unknown";
    }

    function getVedicSign(month, day) {
      const signs = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
      const western = getZodiac(month, day);
      const idx = signs.indexOf(western);
      const vedicIdx = (idx + 11) % 12; // simple shift for sidereal sign
      return signs[vedicIdx];
    }

    function getLifePathNumber(year, month, day) {
      const digits = ("" + year + month + day).split("");
      let sum = digits.reduce((s, d) => s + parseInt(d, 10), 0);
      const reduce = (num) => {
        while (num > 9 && num !== 11 && num !== 22 && num !== 33) {
          num = num.toString().split("").reduce((s, d) => s + parseInt(d, 10), 0);
        }
        return num;
      };
      return reduce(sum);
    }

    const descriptions = {
      Aries: "Energetic, candid, and willful.",
      Taurus: "Reliable, diligent, and conservative.",
      Gemini: "Quick-witted, capricious, and cheerful.",
      Cancer: "Considerate, imaginative, and sensitive.",
      Leo: "Enthusiastic, proud, and expansive.",
      Virgo: "Elegant, perfectionist, and organized.",
      Libra: "Just, kind, and diplomatic.",
      Scorpio: "Insightful, mysterious, and passionate.",
      Sagittarius: "Unconstrained, lively, and optimistic.",
      Capricorn: "Practical, prudent, and patient.",
      Aquarius: "Unique, wise, and idealistic.",
      Pisces: "Romantic, kind, and gentle.",
    };

    function AstroApp() {
      const [month, setMonth] = React.useState(1);
      const [day, setDay] = React.useState(1);
      const [year, setYear] = React.useState(2000);
      const [sign, setSign] = React.useState(null);
      const [vedicSign, setVedicSign] = React.useState(null);
      const [lifePath, setLifePath] = React.useState(null);
      const [showCamera, setShowCamera] = React.useState(false);
      const [stream, setStream] = React.useState(null);
      const videoRef = React.useRef(null);
      const canvasRef = React.useRef(null);
      const overlayRef = React.useRef(null);
      const detectLoop = React.useRef(null);
      const [photo, setPhoto] = React.useState(null);
      const [palmistry, setPalmistry] = React.useState(null);
      const [user, setUser] = React.useState(() => {
        const stored = localStorage.getItem('astroUser');
        return stored ? JSON.parse(stored) : null;
      });

      React.useEffect(() => {
        if (user) return;
        window.handleCredentialResponse = (response) => {
          const data = jwt_decode(response.credential);
          setUser(data);
          localStorage.setItem('astroUser', JSON.stringify(data));
        };
        google.accounts.id.initialize({
          client_id: 'YOUR_GOOGLE_CLIENT_ID', // replace with your client ID
          callback: handleCredentialResponse,
        });
        google.accounts.id.renderButton(
          document.getElementById('googleSignInButton'),
          { theme: 'outline', size: 'large' }
        );
      }, [user]);

      React.useEffect(() => {
        if (showCamera) {
          startPalmDetection();
        } else {
          stopPalmDetection();
        }
      }, [showCamera]);

      React.useEffect(() => {
        if (showCamera && stream && videoRef.current) {
          videoRef.current.srcObject = stream;
        }
      }, [showCamera, stream]);

      const handleSignOut = () => {
        setUser(null);
        localStorage.removeItem('astroUser');
        google.accounts.id.disableAutoSelect();
      };

      const handleGuest = () => {
        const guestUser = { name: 'Guest', guest: true };
        setUser(guestUser);
        localStorage.setItem('astroUser', JSON.stringify(guestUser));
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        const m = parseInt(month, 10);
        const d = parseInt(day, 10);
        const y = parseInt(year, 10);
        const zodiac = getZodiac(m, d);
        const vedic = getVedicSign(m, d);
        const lp = getLifePathNumber(y, m, d);
        setSign(zodiac);
        setVedicSign(vedic);
        setLifePath(lp);
      };

      const openCamera = () => {
        setPalmistry(null);
        setPhoto(null);
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(s => {
            setStream(s);
            setShowCamera(true);
          })
          .catch(err => console.error('Camera error:', err));
      };

      const capturePhoto = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        stopPalmDetection();
        if (video && canvas) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const dataUrl = canvas.toDataURL('image/png');
          setPhoto(dataUrl);
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
          }
          setStream(null);
          setShowCamera(false);
        }
      };

      const startPalmDetection = () => {
        stopPalmDetection();
        const video = videoRef.current;
        const overlay = overlayRef.current;
        if (!video || !overlay) return;
        const ctx = overlay.getContext('2d');
        const detect = () => {
          if (!showCamera) return;
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
          const img = ctx.getImageData(0, 0, overlay.width, overlay.height);
          const palmCheck = containsPalm(img.data, overlay.width, overlay.height);
          ctx.clearRect(0, 0, overlay.width, overlay.height);
          if (palmCheck.detected && palmCheck.bounds) {
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.strokeRect(
              palmCheck.bounds.x,
              palmCheck.bounds.y,
              palmCheck.bounds.width,
              palmCheck.bounds.height
            );
          }
          detectLoop.current = requestAnimationFrame(detect);
        };
        detect();
      };

      const stopPalmDetection = () => {
        if (detectLoop.current) {
          cancelAnimationFrame(detectLoop.current);
          detectLoop.current = null;
        }
        const overlay = overlayRef.current;
        if (overlay) {
          const ctx = overlay.getContext('2d');
          ctx.clearRect(0, 0, overlay.width, overlay.height);
        }
      };

      const isImageClear = (data, width, height) => {
        let total = 0;
        let count = 0;
        for (let y = 1; y < height; y += 2) {
          for (let x = 1; x < width; x += 2) {
            const i = (y * width + x) * 4;
            const lum = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            const iL = (y * width + (x - 1)) * 4;
            const lumL = 0.299 * data[iL] + 0.587 * data[iL + 1] + 0.114 * data[iL + 2];
            const iU = ((y - 1) * width + x) * 4;
            const lumU = 0.299 * data[iU] + 0.587 * data[iU + 1] + 0.114 * data[iU + 2];
            const edge = Math.abs(lum - lumL) + Math.abs(lum - lumU);
            total += edge;
            count++;
          }
        }
        // Lowered threshold to relax blur detection
        return total / count > 10;
      };

      const containsPalm = (data, width, height) => {
        let skin = 0;
        let samples = 0;
        let minX = width, minY = height, maxX = 0, maxY = 0;
        for (let y = 0; y < height; y += 2) {
          for (let x = 0; x < width; x += 2) {
            samples++;
            const i = (y * width + x) * 4;
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            if (
              r > 95 &&
              g > 40 &&
              b > 20 &&
              r > g &&
              r > b &&
              max - min > 15 &&
              Math.abs(r - g) > 15
            ) {
              skin++;
              if (x < minX) minX = x;
              if (y < minY) minY = y;
              if (x > maxX) maxX = x;
              if (y > maxY) maxY = y;
            }
          }
        }
        const detected = skin / samples > 0.2;
        const bounds = detected
          ? { x: minX, y: minY, width: maxX - minX, height: maxY - minY }
          : null;
        return { detected, bounds };
      };

      const analyzePalm = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const { width, height } = canvas;
        const img = ctx.getImageData(0, 0, width, height);
        const data = img.data;
        if (!isImageClear(data, width, height)) {
          setPalmistry('Image too blurry. Please retake the photo.');
          return;
        }
        const palmCheck = containsPalm(data, width, height);
        if (!palmCheck.detected) {
          setPalmistry('No palm detected. Please retake the photo with your hand clearly visible.');
          return;
        }
        if (palmCheck.bounds) {
          ctx.strokeStyle = 'rgba(0, 255, 0, 0.8)';
          ctx.lineWidth = 3;
          ctx.strokeRect(palmCheck.bounds.x, palmCheck.bounds.y, palmCheck.bounds.width, palmCheck.bounds.height);
          ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
          ctx.fillRect(palmCheck.bounds.x, palmCheck.bounds.y, palmCheck.bounds.width, palmCheck.bounds.height);
        }
        const sections = [0, 0, 0]; // heart, head, life
        for (let y = 1; y < height; y++) {
          for (let x = 1; x < width; x++) {
            const i = (y * width + x) * 4;
            const lum = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            const iL = (y * width + (x - 1)) * 4;
            const lumL = 0.299 * data[iL] + 0.587 * data[iL + 1] + 0.114 * data[iL + 2];
            const iU = ((y - 1) * width + x) * 4;
            const lumU = 0.299 * data[iU] + 0.587 * data[iU + 1] + 0.114 * data[iU + 2];
            const edge = Math.abs(lum - lumL) + Math.abs(lum - lumU);
            if (edge > 60) {
              if (y < height / 3) sections[0]++;      // heart line region
              else if (y < (2 * height) / 3) sections[1]++; // head line region
              else sections[2]++;                      // life line region
            }
          }
        }
        const regionArea = (width * height) / 3;
        const heart = sections[0] / regionArea;
        const head = sections[1] / regionArea;
        const life = sections[2] / regionArea;

        let report = '';
        if (heart > 0.15) report += 'Strong heart line: deep emotional connections. ';
        else if (heart > 0.08) report += 'Balanced heart line: steady emotions. ';
        else report += 'Faint heart line: reserved feelings. ';

        if (head > 0.15) report += 'Pronounced head line: sharp intellect. ';
        else if (head > 0.08) report += 'Moderate head line: practical thinking. ';
        else report += 'Short head line: quick decision making. ';

        if (life > 0.15) report += 'Long life line: vitality and enthusiasm.';
        else if (life > 0.08) report += 'Steady life line: consistent energy.';
        else report += 'Short life line: dynamic lifestyle.';

        setPalmistry(report);
      };

      if (!user) {
        return (
          <div className="card">
            <h1>Astrology App</h1>
            <div id="googleSignInButton"></div>
            <button className="guest" onClick={handleGuest}>Continue as Guest</button>
          </div>
        );
      }

      return (
        <div className="card">
          <div className="header">
            <h2>Welcome {user.name}</h2>
            <button className="signout" onClick={handleSignOut}>Sign Out</button>
          </div>
          <form onSubmit={handleSubmit}>
            <div className="field">
              <label>Month</label>
              <input
                type="number"
                value={month}
                onChange={(e) => setMonth(e.target.value)}
                min="1"
                max="12"
                required
              />
            </div>
            <div className="field">
              <label>Day</label>
              <input
                type="number"
                value={day}
                onChange={(e) => setDay(e.target.value)}
                min="1"
                max="31"
                required
              />
            </div>
            <div className="field">
              <label>Year</label>
              <input
                type="number"
                value={year}
                onChange={(e) => setYear(e.target.value)}
                min="1900"
                max="2100"
                required
              />
            </div>
            <button type="submit">Calculate</button>
          </form>
          {sign && (
            <div className="result">
              <h2>Your Western Zodiac sign: {sign}</h2>
              <p>{descriptions[sign]}</p>
              <h3>Vedic (Moon) sign: {vedicSign}</h3>
              <h3>Life Path Number: {lifePath}</h3>
            </div>
          )}
          <div className="palmistry-section">
            <button onClick={openCamera}>Open Camera</button>
            {showCamera && (
              <div className="camera">
                <video ref={videoRef} autoPlay playsInline></video>
                <canvas ref={overlayRef} className="overlay-canvas"></canvas>
                <button onClick={capturePhoto}>Capture</button>
                <p className="hint">Ensure your hand is sharp and fills the frame. Retake if needed.</p>
              </div>
            )}
            <canvas
              ref={canvasRef}
              className="photo-canvas"
              style={{ display: photo ? 'block' : 'none' }}
            ></canvas>
            {photo && (
              <div className="photo-result">
                <button onClick={analyzePalm}>Analyze Palm</button>
                <p className="hint">If prompted, retake your photo for better results.</p>
              </div>
            )}
            {palmistry && (
              <div className="result">
                <h3>Palmistry Report</h3>
                <p>{palmistry}</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<AstroApp />, document.getElementById('root'));
  </script>
</body>
</html>
